<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ø¨Ø­Ø« Ø§Ù„Ø±Ø­Ù„Ø§Øª</title>

<style>
* { box-sizing: border-box; }

body {
  font-family: system-ui, sans-serif;
  background:#f5f7fa;
  margin:0;
  padding:40px 0;
}

.app {
  max-width:480px;
  margin:auto;
  background:#fff;
  border-radius:16px;
  padding:24px;
  box-shadow:0 12px 30px rgba(0,0,0,.08);
}

h1 {
  text-align:center;
  margin:0 0 32px;
}

/* ===== RADIO / CHECKBOX ===== */
.radio-group {
  display:flex;
  justify-content:right;
  gap:32px;
  margin-bottom:20px;
}

.radio-group label,
.checkbox-line label {
  display:inline-flex;
  align-items:center;
  gap:6px;
  font-size:14px;
  cursor:pointer;
  white-space:nowrap;
}

/* ===== FIELDS ===== */
.field { margin-bottom:14px; }

label {
  font-size:14px;
  display:block;
  margin-bottom:6px;
}

input, select {
  width:100%;
  padding:12px;
  border-radius:10px;
  border:1px solid #ddd;
  font-size:14px;
}

/* ===== GRID ===== */
.grid {
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:14px;
  margin-bottom:14px;
}

/* ===== BUTTON ===== */
button {
  width:100%;
  padding:14px;
  border-radius:12px;
  border:none;
  background:#2563eb;
  color:#fff;
  font-size:16px;
  cursor:pointer;
  margin-top:14px;
}

/* ===== FILTERS ===== */
.filters {
  margin-top:26px;
  padding-top:20px;
  border-top:1px solid #eee;
}

.range-box { padding:0 4px; }
.range-box input { width:100%; }

.checkbox-line { margin:10px 0; }

/* ===== RESULTS ===== */
.flight-card {
  border:1px solid #eee;
  border-radius:12px;
  padding:14px;
  margin-top:12px;
}

.flight-header {
  display:flex;
  justify-content:space-between;
  margin-bottom:6px;
  font-size:14px;
}

.airline {
  font-weight:600;
}

.time {
  font-size:13px;
  color:#555;
}

.duration {
  font-size:13px;
  color:#666;
  margin-top:4px;
}

.price {
  color:#2563eb;
  font-size:18px;
  font-weight:bold;
  margin-top:6px;
}

.error {
  background:#fee2e2;
  color:#991b1b;
  padding:10px;
  border-radius:10px;
  margin-bottom:12px;
  display:none;
}

.autocomplete {
  position: absolute;
  top: 100%;
  right: 0;
  left: 0;
  background: #fff;
  border: 1px solid #e5e7eb;
  border-radius: 10px;
  margin-top: 6px;
  box-shadow: 0 10px 25px rgba(0,0,0,0.08);
  z-index: 9999;
  max-height: 240px;
  overflow-y: auto;
}


.field {
  position: relative;
}

.autocomplete div {
  padding: 10px 14px;
  cursor: pointer;
  font-size: 14px;
  border-bottom: 1px solid #f1f5f9;
}

.autocomplete div:last-child {
  border-bottom: none;
}

.autocomplete div:hover {
  background: #f8fafc;
}

.input-wrap{
  position: relative;
}


.input-wrap {
  position: relative;
}

.input-wrap input {
  padding-left: 42px; /* Ù…Ø³Ø§Ø­Ø© Ù„Ù„Ø²Ø± âœ• */
}


.clear-btn {
  position: absolute;
  left: 10px;
  top: 50%;
  transform: translateY(-50%);
  width: 28px;
  height: 28px;
  border-radius: 8px;
  cursor: pointer;
  display: none;   /* ğŸ‘ˆ Ø§Ù„ØªØ­ÙƒÙ… Ø¨ÙŠÙƒÙˆÙ† Ø¨Ø§Ù„Ù€ JS */
  align-items: center;
  justify-content: center;
  color: #6b7280;
}



.clear-btn:hover {
  background: #d1d5db;
}


.input-wrap input:focus + .clear-btn {
  display: block;
}

.clear-btn:hover {
  color: #111;
}

.locations-wrap {
  position: relative;
}

.swap-btn {
  position: absolute;
  top: 28px;
  left: 50%;
  transform: translateX(-50%);
  width: 36px;
  height: 36px;
  border-radius: 50%;
  border: 1px solid #e5e7eb;
  background: #fff;
  cursor: pointer;
  font-size: 16px;
  z-index: 5;
  transition: all .2s ease;
}

.swap-btn:hover {
  background: #f3f4f6;
  transform: translateX(-50%) rotate(180deg);
}

.passenger-box {
  border: 1px solid #ddd;
  padding: 12px;
  border-radius: 8px;
  cursor: pointer;
}

.passenger-popup {
  display: none;
  position: absolute;
  background: #fff;
  border: 1px solid #ddd;
  padding: 12px;
  border-radius: 8px;
  margin-top: 6px;
  z-index: 1000;
}

.passenger-popup .row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}


</style>
</head>

<body>

<div class="app">

<h1>Ø¨Ø­Ø« Ø§Ù„Ø±Ø­Ù„Ø§Øª âœˆï¸</h1>

<!-- Ù†ÙˆØ¹ Ø§Ù„Ø±Ø­Ù„Ø© -->
<div class="radio-group">
  <label>
    Ø°Ù‡Ø§Ø¨ ÙÙ‚Ø·
    <input type="radio" name="tripType" checked onclick="setTripType('oneway')">
  </label>
  <label>
    Ø°Ù‡Ø§Ø¨ ÙˆØ¹ÙˆØ¯Ø©
    <input type="radio" name="tripType" onclick="setTripType('round')">
  </label>
</div>

<div id="errorBox" class="error"></div>

<!-- Ø§Ù„Ù…Ø¯Ù† -->
<div class="locations-wrap">

  <!-- Ø²Ø± Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ -->
  <button type="button" class="swap-btn" onclick="swapLocations()">â‡„</button>

  <div class="grid">
    <!-- Ù…Ù† -->
    <div class="field">
      <label>Ù…Ù†</label>
      <div class="input-wrap">
        <input id="fromInput" type="text" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø£Ùˆ Ø§Ù„Ù…Ø·Ø§Ø±">
        <span class="clear-btn" onclick="clearInput('fromInput','fromResults')">
          âœ•
        </span>
        <div id="fromResults" class="autocomplete"></div>
      </div>
    </div>

    <!-- Ø¥Ù„Ù‰ -->
    <div class="field">
      <label>Ø¥Ù„Ù‰</label>
      <div class="input-wrap">
        <input id="toInput" type="text" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø£Ùˆ Ø§Ù„Ù…Ø·Ø§Ø±">
        <span class="clear-btn" onclick="clearInput('toInput','toResults')">
          âœ•
        </span>
        <div id="toResults" class="autocomplete"></div>
      </div>
    </div>
  </div>

</div>





<!-- Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® -->
<div class="grid">
  <div class="field">
    <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø°Ù‡Ø§Ø¨</label>
    <input type="date" id="departDate" min="">
  </div>
  <div class="field" id="returnBox" style="display:none;">
    <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¹ÙˆØ¯Ø©</label>
    <input type="date" id="returnDate">
  </div>
</div>

<!-- Ø§Ù„Ø±ÙƒØ§Ø¨ -->
<div class="field">
  <label>Ø¹Ø¯Ø¯ Ø§Ù„Ø±ÙƒØ§Ø¨</label>

  <div class="passenger-box" id="passengerBox">
    <span id="passengerSummary">1 Ø¨Ø§Ù„Øº</span>
  </div>


  <div class="passenger-popup" id="passengerPopup">
    <div class="row">
      <span>Ø¨Ø§Ù„ØºÙŠÙ†</span>
      <button type="button" onclick="changePax('adults', -1)">âˆ’</button>
      <span id="adultsCount">1</span>
      <button type="button" onclick="changePax('adults', 1)">+</button>
    </div>

    <div class="row">
      <span>Ø£Ø·ÙØ§Ù„</span>
      <button type="button" onclick="changePax('children', -1)">âˆ’</button>
      <span id="childrenCount">0</span>
      <button type="button" onclick="changePax('children', 1)">+</button>
    </div>

    <div class="row">
      <span>Ø±Ø¶Ø¹</span>
      <button type="button" onclick="changePax('infants', -1)">âˆ’</button>
      <span id="infantsCount">0</span>
      <button type="button" onclick="changePax('infants', 1)">+</button>
    </div>
  </div>
</div>


<button onclick="searchFlights()">Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø±Ø­Ù„Ø§Øª</button>

<!-- Ø§Ù„ÙÙ„ØªØ±Ø© -->
<div class="filters">
  <label>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø£Ù‚ØµÙ‰: <strong id="priceLabel">2000 SAR</strong></label>
  <div class="range-box">
    <input type="range" min="200" max="2000" step="50"
           value="2000" id="priceRange"
           oninput="applyFilters()">
  </div>

  <div class="checkbox-line">
    <label>
      Ù…Ø¨Ø§Ø´Ø± ÙÙ‚Ø·
      <input type="checkbox" id="directOnly"
             onchange="applyFilters()">
    </label>
  </div>

  <label>ØªØ±ØªÙŠØ¨ Ø§Ù„Ù†ØªØ§Ø¦Ø¬</label>
  <select id="sortBy" onchange="applyFilters()">
    <option value="cheap">Ø§Ù„Ø£Ø±Ø®Øµ</option>
    <option value="expensive">Ø§Ù„Ø£ØºÙ„Ù‰</option>
  </select>
</div>

<div id="results"></div>

</div>

<script>
let passengerState = {
  adults: 1,
  children: 0,
  infants: 0
};


const departDate = document.getElementById("departDate");
const returnDate = document.getElementById("returnDate");
const results = document.getElementById("results");
const errorBox = document.getElementById("errorBox");
const priceRange = document.getElementById("priceRange");
const priceLabel = document.getElementById("priceLabel");
const directOnly = document.getElementById("directOnly");
const sortBy = document.getElementById("sortBy");

let tripType="oneway";



const AIRPORTS = [
  { code: "RUH", city: "Ø§Ù„Ø±ÙŠØ§Ø¶", airport: "Ù…Ø·Ø§Ø± Ø§Ù„Ù…Ù„Ùƒ Ø®Ø§Ù„Ø¯ Ø§Ù„Ø¯ÙˆÙ„ÙŠ" },
  { code: "JED", city: "Ø¬Ø¯Ø©", airport: "Ù…Ø·Ø§Ø± Ø§Ù„Ù…Ù„Ùƒ Ø¹Ø¨Ø¯Ø§Ù„Ø¹Ø²ÙŠØ² Ø§Ù„Ø¯ÙˆÙ„ÙŠ" },
  { code: "DMM", city: "Ø§Ù„Ø¯Ù…Ø§Ù…", airport: "Ù…Ø·Ø§Ø± Ø§Ù„Ù…Ù„Ùƒ ÙÙ‡Ø¯ Ø§Ù„Ø¯ÙˆÙ„ÙŠ" },
  { code: "MED", city: "Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ù…Ù†ÙˆØ±Ø©", airport: "Ù…Ø·Ø§Ø± Ø§Ù„Ø£Ù…ÙŠØ± Ù…Ø­Ù…Ø¯ Ø¨Ù† Ø¹Ø¨Ø¯Ø§Ù„Ø¹Ø²ÙŠØ²" },
  { code: "AHB", city: "Ø£Ø¨Ù‡Ø§", airport: "Ù…Ø·Ø§Ø± Ø£Ø¨Ù‡Ø§ Ø§Ù„Ø¥Ù‚Ù„ÙŠÙ…ÙŠ" },
  { code: "TIF", city: "Ø§Ù„Ø·Ø§Ø¦Ù", airport: "Ù…Ø·Ø§Ø± Ø§Ù„Ø·Ø§Ø¦Ù Ø§Ù„Ø¯ÙˆÙ„ÙŠ" }
];

// ===== Ù‚Ø§Ù…ÙˆØ³ Ø´Ø±ÙƒØ§Øª Ø§Ù„Ø·ÙŠØ±Ø§Ù† =====
const AIRLINES = {
  SV: "Ø§Ù„Ø®Ø·ÙˆØ· Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©",
  XY: "Ø·ÙŠØ±Ø§Ù† Ù†Ø§Ø³",
  F3: "ÙÙ„Ø§ÙŠ Ø£Ø¯ÙŠÙ„",
  FZ: "ÙÙ„Ø§ÙŠ Ø¯Ø¨ÙŠ",
  EK: "Ø·ÙŠØ±Ø§Ù† Ø§Ù„Ø¥Ù…Ø§Ø±Ø§Øª",
  QR: "Ø§Ù„Ø®Ø·ÙˆØ· Ø§Ù„Ù‚Ø·Ø±ÙŠØ©",
  KU: "Ø§Ù„Ø®Ø·ÙˆØ· Ø§Ù„ÙƒÙˆÙŠØªÙŠØ©",
  GF: "Ø·ÙŠØ±Ø§Ù† Ø§Ù„Ø®Ù„ÙŠØ¬"
};

// Ø§Ø®ØªØ± OTA Ø§ÙØªØ±Ø§Ø¶ÙŠ (Ù†Ù‚Ø¯Ø± Ù†Ø¨Ø¯Ù„Ù‡ Ù„Ø§Ø­Ù‚Ù‹Ø§)
const DEFAULT_OTA = "kiwi"; // kiwi | trip | budgetair (Ù„Ø§Ø­Ù‚Ù‹Ø§)

// ÙŠØ¨Ù†ÙŠ Ø±Ø§Ø¨Ø· Affiliate Ø¨Ø­Ø«ÙŠ (Context-based)
function buildAffiliateLink(f) {
  const origin = f.round ? f.outbound.from : f.from;
  const destination = f.round ? f.outbound.to : f.to;
  const depart = departDate.value;
  const ret = (tripType === "round") ? returnDate.value : "";

  const adults = passengerState.adults || 1;
  const children = passengerState.children || 0;
  const infants = passengerState.infants || 0;

  const AFF_ID = "YOUR_AFF_ID";

  if (DEFAULT_OTA === "kiwi") {
    let url = `https://www.kiwi.com/en/search/results/${origin}/${destination}`;
    if (depart) url += `/${depart}`;
    if (ret) url += `/${ret}`;
    url += `?adults=${adults}&children=${children}&infants=${infants}&affilid=${AFF_ID}`;
    return url;
  }

  if (DEFAULT_OTA === "trip") {
    let url = `https://www.trip.com/flights/${origin}-${destination}?`;
    if (depart) url += `departDate=${depart}&`;
    if (ret) url += `returnDate=${ret}&`;
    url += `adults=${adults}&children=${children}&infants=${infants}`;
    return url;
  }

  return `https://www.google.com/travel/flights?q=${origin}-${destination}`;
}




function airlineName(code) {
  return AIRLINES[code] || code;
}

// ===== ØªØ­ÙˆÙŠÙ„ Ù…Ø¯Ø© Amadeus Ø¥Ù„Ù‰ Ø¹Ø±Ø¨ÙŠ =====
function formatDuration(iso) {
  // Ù…Ø«Ø§Ù„: PT2H10M
  if (!iso) return "";
  let h = 0, m = 0;
  const hMatch = iso.match(/(\d+)H/);
  const mMatch = iso.match(/(\d+)M/);
  if (hMatch) h = parseInt(hMatch[1], 10);
  if (mMatch) m = parseInt(mMatch[1], 10);
  if (h && m) return `${h} Ø³ ${m} Ø¯`;
  if (h) return `${h} Ø³`;
  if (m) return `${m} Ø¯`;
  return "";
}

// ===== Ù†Øµ Ø§Ù„ØªÙˆÙ‚ÙØ§Øª =====
function stopsText(stops) {
  if (stops === 0) return "Ù…Ø¨Ø§Ø´Ø±";
  if (stops === 1) return "ØªÙˆÙ‚Ù ÙˆØ§Ø­Ø¯";
  return `ØªÙˆÙ‚Ù ${stops}`;
}



let allFlights=[];
let filteredFlights=[];

function setTripType(type) {
  tripType = type;

  const returnBox = document.getElementById("returnBox");
  if (!returnBox) return;

  returnBox.style.display = type === "round" ? "block" : "none";
}


function showError(msg){
  errorBox.innerText=msg;
  errorBox.style.display="block";
}

function clearError(){
  errorBox.style.display="none";
}


function buildKiwiUrl({ from, to, departDate, returnDate, passengers }) {

  // ØªØ£ÙƒØ¯ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ù…ÙˆØ¬ÙˆØ¯Ø©
  if (!from || !to || !departDate) return "#";

  let url = `https://www.kiwi.com/en/search/results/${from}/${to}/${departDate}`;

  // Ø£Ø¶Ù Ø§Ù„Ø¹ÙˆØ¯Ø© ÙÙ‚Ø· Ù„Ùˆ Round trip
  if (returnDate && returnDate !== "") {
    url += `/${returnDate}`;
  }

  url += `?adults=${passengers || 1}`;

  return url;
}


async function searchFlights() {
  clearError();
  passengerPopup.style.display = "none";

  results.innerHTML = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø±Ø­Ù„Ø§Øª...";
  const fromIata = fromInput.dataset.iata;
  const toIata = toInput.dataset.iata;
  

  if (!fromIata || !toIata) {
    showError("Ø§Ø®ØªØ± Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ù…ØºØ§Ø¯Ø±Ø© ÙˆØ§Ù„ÙˆØµÙˆÙ„ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©");
    results.innerHTML = "";
    return;
  }


  // ===== Validations =====
  if (!departDate.value) {
    showError("Ø§Ø®ØªØ± ØªØ§Ø±ÙŠØ® Ø§Ù„Ø°Ù‡Ø§Ø¨");
    results.innerHTML = "";
    return;
  }

  if (tripType === "round" && !returnDate.value) {
    showError("Ø§Ø®ØªØ± ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¹ÙˆØ¯Ø©");
    results.innerHTML = "";
    return;
  }

  if (!fromInput.value || !toInput.value) {
    showError("Ø§Ø®ØªØ± Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ù…ØºØ§Ø¯Ø±Ø© ÙˆØ§Ù„ÙˆØµÙˆÙ„");
    results.innerHTML = "";
    return;
  }

  if (fromInput.value === toInput.value) {
    showError("Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ù…ØºØ§Ø¯Ø±Ø© ÙˆØ§Ù„ÙˆØµÙˆÙ„ ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ù…Ø®ØªÙ„ÙØ©");
    results.innerHTML = "";
    return;
  }

  if (
    tripType === "round" &&
    returnDate.value < departDate.value
  ) {
    showError("ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¹ÙˆØ¯Ø© ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø¨Ø¹Ø¯ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø°Ù‡Ø§Ø¨");
    results.innerHTML = "";
    return;
  }

  if (!fromInput.dataset.iata || !toInput.dataset.iata) {
  showError("Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©");
  return;
  }


  // ===== API Call =====
  try {
    const res = await fetch("https://ahsanha-api.up.railway.app/search-flights", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        tripType,
        from: fromIata,
        to: toIata,
        departDate: departDate.value,
        returnDate: tripType === "round" ? returnDate.value : "",
        passengers: {
          adults: passengerState.adults,
          children: passengerState.children,
          infants: passengerState.infants
        }

      })

    });

    const data = await res.json();
    console.log("API response:", data);


   if (!data.flights || data.flights.length === 0) {
      results.innerHTML = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø­Ù„Ø§Øª";
      return;
    }

    allFlights = data.flights.map(f => {
      // Ù„Ùˆ oneway
      if (data.type === "oneway") {
        return {
          ...f,
          round: false
        };
      }

      // Ù„Ùˆ round
      return {
        ...f,
        round: true
      };
    });

    applyFilters();


  } catch (e) {
    showError("Ø­ØµÙ„ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø§Ù„Ø±Ø­Ù„Ø§Øª");
    results.innerHTML = "";
  }
}

function applyFilters() {
  const max = Number(priceRange.value);
  const direct = directOnly.checked;
  const sort = sortBy.value;

  // ÙÙ„ØªØ±Ø©
  filteredFlights = allFlights.filter(f => {
    const price = Number(f.price);

    if (price > max) return false;

    // directOnly ÙŠÙ†Ø·Ø¨Ù‚ ÙÙ‚Ø· Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø­Ù„Ø§Øª Ø§Ù„Ù„ÙŠ ÙÙŠÙ‡Ø§ stops
    if (direct) {
      if (f.round) {
        if (f.outbound.stops !== 0 || f.inbound.stops !== 0) return false;
      } else {
        if (f.stops !== 0) return false;
      }
    }

    return true;
  });

  // ØªØ±ØªÙŠØ¨
  if (sort === "cheap") {
    filteredFlights.sort((a, b) => Number(a.price) - Number(b.price));
  }

  if (sort === "expensive") {
    filteredFlights.sort((a, b) => Number(b.price) - Number(a.price));
  }

  priceLabel.innerText = max + " SAR";
  renderFlights();
}


function renderFlights(){
  results.innerHTML="";

  filteredFlights.forEach(f=>{
      
    const bestOTA = pickCheapestOTA(f);
    const kiwiUrl = buildKiwiLink({
      fromSlug: fromInput.dataset.slug || f.from,
      toSlug: toInput.dataset.slug || f.to,
      departDate: departDate.value,
      returnDate: "",
      adults: passengerState.adults,
      children: passengerState.children,
      infants: passengerState.infants
    });


    /* ===== Round trip ===== */
    if (f.round === true) {
      results.innerHTML += `
      <div class="flight-card">

        <div class="airline">${airlineName(f.outbound.airline)}</div>


        <div class="flight-header">
          <strong>Ø°Ù‡Ø§Ø¨</strong>
          <span class="time">
            ${f.outbound.from} â†’ ${f.outbound.to}
          </span>
        </div>

        <div class="time">
          ${f.outbound.departTime} â†’ ${f.outbound.arriveTime}
        </div>

        <div class="duration">
          ${formatDuration(f.outbound.duration)} â€¢ ${stopsText(f.outbound.stops)}
        </div>


        <hr style="border:none;border-top:1px solid #eee;margin:10px 0;">

        <div class="flight-header">
          <strong>Ø¹ÙˆØ¯Ø©</strong>
          <span class="time">
            ${f.inbound.from} â†’ ${f.inbound.to}
          </span>
        </div>

        <div class="time">
          ${f.inbound.departTime} â†’ ${f.inbound.arriveTime}
        </div>

        <div class="duration">
          ${formatDuration(f.inbound.duration)} â€¢ ${stopsText(f.inbound.stops)}
        </div>


        <div class="price">SAR ${f.price}</div>


        <div style="font-size:12px;color:#666;margin-top:4px;">
          Ø³Ø¹Ø± ØªÙ‚Ø±ÙŠØ¨ÙŠ: SAR ${bestOTA.estimatedPrice}
        </div>

        <a class="book-btn" href="${buildKiwiLink()}" target="_blank">
          Ø§Ø­Ø¬Ø² Ù…Ù† Kiwi
        </a>



      </div>`;
      return;
    }

    /* ===== One way ===== */
    results.innerHTML += `
    <div class="flight-card">
      <div class="airline">${airlineName(f.airline)}</div>
      <div class="time">${f.from} â†’ ${f.to}</div>
      <div class="time">${f.departTime} â†’ ${f.arriveTime}</div>
      <div class="duration">${formatDuration(f.duration)} â€¢ ${stopsText(f.stops)}</div>
      <div class="price">SAR ${f.price}</div>
      <a class="book-btn" href="${kiwiUrl}" target="_blank">
       Ø§Ø­Ø¬Ø² Ù…Ù† Kiwi
      </a>

    </div>`;
  });
}

const today = new Date().toISOString().split("T")[0];
document.getElementById("departDate").min = today;
document.getElementById("returnDate").min = today;

// ===== Ø¶Ø¨Ø· ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ø°Ù‡Ø§Ø¨ ÙˆØ§Ù„Ø¹ÙˆØ¯Ø© =====
departDate.addEventListener("change", () => {
  // Ø£Ù‚Ù„ ØªØ§Ø±ÙŠØ® Ù„Ù„Ø¹ÙˆØ¯Ø© = ØªØ§Ø±ÙŠØ® Ø§Ù„Ø°Ù‡Ø§Ø¨
  returnDate.min = departDate.value;

  // Ù„Ùˆ ÙƒØ§Ù†Øª Ø§Ù„Ø¹ÙˆØ¯Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø°Ù‡Ø§Ø¨ Ù†Ù„ØºÙŠÙ‡Ø§
  if (returnDate.value && returnDate.value < departDate.value) {
    returnDate.value = "";
  }
});

function buildBookingLink(f) {
  const origin = f.round ? f.outbound.from : f.from;
  const destination = f.round ? f.outbound.to : f.to;
  const depart = departDate.value;
  const ret = tripType === "round" ? returnDate.value : "";

  // Placeholder (Ù„Ø§Ø­Ù‚Ù‹Ø§ Ù†Ø­Ø·Ù‡ Affiliate link Ù…Ù† Travelpayouts)
  let url = `https://www.google.com/travel/flights?q=${origin}-${destination}`;

  if (depart) url += `-${depart}`;
  if (ret) url += `-${ret}`;

  return url;
}

const OTA_PROVIDERS = [
  {
    id: "kiwi",
    name: "Kiwi.com",
    buildLink: (ctx) => {
      let url = `https://www.kiwi.com/en/search/results/${ctx.origin}/${ctx.destination}`;
      if (ctx.depart) url += `/${ctx.depart}`;
      if (ctx.returnDate) url += `/${ctx.returnDate}`;
      url += `?adults=${ctx.pax}&affilid=YOUR_AFF_ID`;
      return url;
    },
    // Mock pricing modifier (Ù†Ø¨Ø¯Ù„Ù‡ Ù„Ø§Ø­Ù‚Ù‹Ø§)
    priceFactor: 0.98
  },
  {
    id: "trip",
    name: "Trip.com",
    buildLink: (ctx) => {
      let url = `https://www.trip.com/flights/${ctx.origin}-${ctx.destination}?`;
      if (ctx.depart) url += `departDate=${ctx.depart}&`;
      if (ctx.returnDate) url += `returnDate=${ctx.returnDate}&`;
      url += `adults=${ctx.pax}&AllianceID=YOUR_AFF_ID`;
      return url;
    },
    priceFactor: 1.0
  },
  {
    id: "budgetair",
    name: "BudgetAir",
    buildLink: (ctx) => {
      let url = `https://www.budgetair.com/en/flights/${ctx.origin}/${ctx.destination}?`;
      if (ctx.depart) url += `departureDate=${ctx.depart}&`;
      if (ctx.returnDate) url += `returnDate=${ctx.returnDate}&`;
      url += `adults=${ctx.pax}`;
      return url;
    },
    priceFactor: 1.02
  }
];

function pickCheapestOTA(f) {
  const basePrice = Number(f.price);

  const ctx = {
    origin: f.round ? f.outbound.from : f.from,
    destination: f.round ? f.outbound.to : f.to,
    depart: departDate.value,
    returnDate: (tripType === "round") ? returnDate.value : "",
    pax: passengerState.adults || 1,
    children: passengerState.children || 0,
    infants: passengerState.infants || 0
  };

  let best = null;

  OTA_PROVIDERS.forEach(ota => {
    const estimatedPrice = Math.round(basePrice * ota.priceFactor);

    if (!best || estimatedPrice < best.estimatedPrice) {
      best = {
        id: ota.id,
        name: ota.name,
        estimatedPrice,
        link: ota.buildLink(ctx)
      };
    }
  });

  return best;
}


function setupAutocomplete(inputId, resultsId) {
  const input = document.getElementById(inputId);
  const resultsBox = document.getElementById(resultsId);
  const clearBtn = input.parentElement.querySelector(".clear-btn");

  if (!input || !resultsBox || !clearBtn) return;

  let timer = null;

  input.addEventListener("input", () => {
    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        const first = resultsBox.querySelector("div");
        if (first) {
          first.click();
          e.preventDefault();
        }
      }
    });

    if (input.readOnly) return;

    clearTimeout(timer);
    const q = input.value.trim();

    if (q.length < 2) {
      resultsBox.innerHTML = "";
      return;
    }

    timer = setTimeout(async () => {
      try {
        const res = await fetch(`https://ahsanha-api.up.railway.app/locations/?q=${encodeURIComponent(q)}`);

        const data = await res.json();

        resultsBox.innerHTML = "";

        data.forEach(loc => {
          if (!loc.iata) return;

          const div = document.createElement("div");

          const label = loc.city; // Riyadh
          const slug = loc.slug || loc.iata.toLowerCase();

          div.textContent = `${label} (${loc.iata})`;

          div.onclick = () => {
            input.value = `${label} (${loc.iata})`;
            input.dataset.iata = loc.iata;
            input.dataset.slug = slug;
            input.readOnly = true;

            clearBtn.style.display = "flex";
            resultsBox.innerHTML = "";
          };

          resultsBox.appendChild(div);
        });


      } catch (e) {
        resultsBox.innerHTML = "";
      }
    }, 250);
  });
}



function clearInput(inputId, resultsId) {
  const input = document.getElementById(inputId);
  const results = document.getElementById(resultsId);
  const clearBtn = input.parentElement.querySelector(".clear-btn");

  input.value = "";
  input.dataset.iata = "";
  input.readOnly = false;

  if (results) results.innerHTML = "";
  if (clearBtn) clearBtn.style.display = "none";

  input.focus();
}

function swapLocations() {
  const fromInput = document.getElementById("fromInput");
  const toInput = document.getElementById("toInput");

  const fromWrap = fromInput.closest(".input-wrap");
  const toWrap = toInput.closest(".input-wrap");

  // Ø®Ø²Ù‘Ù† Ø§Ù„Ù‚ÙŠÙ…
  const fromValue = fromInput.value;
  const fromIata = fromInput.dataset.iata;

  const toValue = toInput.value;
  const toIata = toInput.dataset.iata;

  // Ø¨Ø¯Ù‘Ù„
  fromInput.value = toValue || "";
  fromInput.dataset.iata = toIata || "";

  toInput.value = fromValue || "";
  toInput.dataset.iata = fromIata || "";

  // readOnly
  fromInput.readOnly = !!toIata;
  toInput.readOnly = !!fromIata;

  // Ø²Ø± âœ•
  fromWrap.classList.toggle("has-value", !!toIata);
  toWrap.classList.toggle("has-value", !!fromIata);
}

function buildKiwiLink() {
  const fromSlug = fromInput.dataset.slug;
  const toSlug = toInput.dataset.slug;

  if (!fromSlug || !toSlug) return "#";

  let url = `https://www.kiwi.com/en/search/results/${fromSlug}/${toSlug}/${departDate.value}`;

  if (tripType === "round") {
    url += `/${returnDate.value}`;
  }

  url += `?adults=${passengerState.adults}`;
  url += `&children=${passengerState.children}`;
  url += `&infants=${passengerState.infants}`;
  url += `&currency=SAR&locale=ar`;
  url += `&affilid=485890`;

  return url;
}





setupAutocomplete("fromInput", "fromResults", "fromClear");
setupAutocomplete("toInput", "toResults", "toClear");
// ===== Passenger State =====


const passengerBox = document.getElementById("passengerBox");
const passengerPopup = document.getElementById("passengerPopup");
const passengerSummary = document.getElementById("passengerSummary");

const adultsCount = document.getElementById("adultsCount");
const childrenCount = document.getElementById("childrenCount");
const infantsCount = document.getElementById("infantsCount");

// ÙØªØ­ / Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø±ÙƒØ§Ø¨
passengerBox.addEventListener("click", () => {
  passengerPopup.style.display =
    passengerPopup.style.display === "block" ? "none" : "block";
});

// Ø¥ØºÙ„Ø§Ù‚ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø®Ø§Ø±Ø¬Ù‡Ø§
document.addEventListener("click", (e) => {
  if (
    !passengerBox.contains(e.target) &&
    !passengerPopup.contains(e.target)
  ) {
    passengerPopup.style.display = "none";
  }
});


function updatePassengerUI() {
  document.getElementById("adultsCount").innerText = passengerState.adults;
  document.getElementById("childrenCount").innerText = passengerState.children;
  document.getElementById("infantsCount").innerText = passengerState.infants;

  let parts = [];
  if (passengerState.adults) parts.push(`${passengerState.adults} Ø¨Ø§Ù„Øº`);
  if (passengerState.children) parts.push(`${passengerState.children} Ø·ÙÙ„`);
  if (passengerState.infants) parts.push(`${passengerState.infants} Ø±Ø¶ÙŠØ¹`);

  passengerSummary.innerText = parts.join("ØŒ ");
}


// ===== Change passengers =====
function changePax(type, delta) {
  if (type === "adults") {
    passengerState.adults = Math.max(1, passengerState.adults + delta);
  }

  if (type === "children") {
    passengerState.children = Math.max(0, passengerState.children + delta);
  }

  if (type === "infants") {
    passengerState.infants = Math.max(0, passengerState.infants + delta);
    // Ù„Ø§ ÙŠØ²ÙŠØ¯ Ø§Ù„Ø±Ø¶Ø¹ Ø¹Ù† Ø¹Ø¯Ø¯ Ø§Ù„Ø¨Ø§Ù„ØºÙŠÙ†
    passengerState.infants = Math.min(
      passengerState.infants,
      passengerState.adults
    );
  }

  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø±Ù‚Ø§Ù…
  adultsCount.innerText = passengerState.adults;
  childrenCount.innerText = passengerState.children;
  infantsCount.innerText = passengerState.infants;

  updatePassengerSummary();
}

// ===== Summary text =====
function updatePassengerSummary() {
  let text = `${passengerState.adults} Ø¨Ø§Ù„Øº`;
  if (passengerState.children) text += `ØŒ ${passengerState.children} Ø·ÙÙ„`;
  if (passengerState.infants) text += `ØŒ ${passengerState.infants} Ø±Ø¶ÙŠØ¹`;
  passengerSummary.innerText = text;
}





</script>

</body>
</html>